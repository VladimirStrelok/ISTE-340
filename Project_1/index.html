<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Project 1</title>
  <link rel="stylesheet" href="css/styles.css">

  <!--[if lt IE 9]>
    <script>
      document.createElement('nav');
      document.createElement('header');
      document.createElement('main');
      document.createElement('section');
    </script>
  <![endif]-->
  <!--[if lt IE 8]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/json3/3.3.2/json3.min.js"></script>
  <![endif]-->
  <!--[if lt IE 7]>
    <script>
      window.location = 'http://whatbrowser.org/';
    </script>
  <![endif]-->


  <script>
  //fixing IE8 isue with Object.keys
  if (!Object.keys) {
    Object.keys = function(obj) {
      var keys = [];
      for (var i in obj) {
        if (obj.hasOwnProperty(i)) {
          keys.push(i);
        }
      }
      return keys;
    };
  }
  // Shortcuts
  var $, __, _, __;

  // getElementById shortcut
  $ = function (id){
    return document.getElementById(id);
  }

  // getElementsTagName shortcut
  $$ = function (tag,which){
    if(which){
      return document.getElementsByTagName(tag)[which];
    }
    else{
      return document.getElementsByTagName(tag);
    }
  }

  //createElement shortcut
  _ = function (tag, attributes){
    var ele = document.createElement(tag);
    if(attributes){
      for(var i = 0, l = attributes.length; i < l; i ++){
        ele.setAttribute(attributes[i][0],attributes[i][1]);
      }
    }
    return ele;
  }

  __ = function(text){
    return document.createTextNode(text);
  }

  // variables
  var jsonData, activeDatasetName, activeDataset, form;

  // functions
  var getData, startUp, setUp, createSection, createSelect, selectChange, generateNav, anchorClick, print, getSelected, reset;

  getData = function(){
    var request, response;
    request = new XMLHttpRequest();
    request.open( "GET", "./data2.json", true );
    request.setRequestHeader("Content-type", "application/json");

    request.onreadystatechange = function(){
      if( request.readyState == 4 && request.status == 200 ){
        jsonData = JSON.parse( request.responseText );
        startUp();
      }
    }
    request.send();
  }

  startUp = function(){
    activeDatasetName = Object.keys(jsonData)[0];
    form = document.forms[0];
    generateNav();
    setUp();
  }
  generateNav = function(){
    var keys, nav;
    keys = Object.keys(jsonData);
    nav = $("nav");
    for(var i=0, l=keys.length; i < l; i++){
      var key, anchor;
      key = keys[i];
      anchor = _('a',[["id",key],["onclick","anchorClick(this)"]]);
      anchor.appendChild(__(jsonData[key].text));
      nav.appendChild(anchor);
    }
  }

  setUp = function(){
    var initial, category;

    while(form.firstChild){
      form.removeChild(form.firstChild);
    }

    activeDataset = jsonData[activeDatasetName];
    $(activeDatasetName).setAttribute('class','active');

    initial = createSection(activeDataset);
    form.appendChild(initial);

    category = $('category');
    category.addChild = activeDataset.value;
  }

  createSection = function(data){
    var section, question, select;

    section = _('section');

    question = _('span');
    question.appendChild(__(data.question));
    section.appendChild(question);

    select = createSelect(data.answers);
    section.appendChild(select);

    return section;
  }

  createSelect = function(data){
    var element = _('select',[['onchange','selectChange(this)']]);
    var firstChild =  _("option",[["value",""],["disabled", true],["selected", true],["hidden", true]]);
    firstChild.appendChild(__("Choose an Option"));
    element.appendChild(firstChild);
    var keys = Object.keys(data);
    for(var i=0, l=keys.length; i < l; i++){
      var key = keys[i];
      var child = _('option',[['value',key]]);
      child.appendChild(__(data[key].text));
      element.appendChild(child);
    }
    return element;
  }
  selectChange = function(cur){;
    var output = $('output');
    while(cur.parentNode.nextSibling){
      cur.parentNode.parentNode.removeChild(cur.parentNode.nextSibling)
      while(output.firstChild){
        output.removeChild(output.firstChild);
      }
    }
    var currentData = activeDataset;
    var values = getSelectedValues();
    for(var i = 0, l = values.length; i < l; i++){
      currentData = currentData.answers[values[i]];
    }
    if(currentData.answers){
      var nextChild = createSection(currentData);
    }
    else{
      print();
    }
    if(nextChild){
      form.appendChild(nextChild);
    }

  }

  anchorClick = function(anchor){
    if(anchor.id != activeDatasetName){
      var nav = $("nav");
      var anchors = nav.getElementsByTagName('a');
      for(var i = 0, l=anchors.length; i < l; i++){
        anchors[i].setAttribute('class','');
      }
      activeDatasetName = anchor.id;
      setUp();
    }
  }
  print = function(){
    var values = getSelectedValues();
    var printTable = _('table');
    var currentData = activeDataset;
    for(var i = 0, l = values.length; i < l; i++){
      printTable.appendChild(createRow([currentData.question, currentData.answers[values[i]].text]))
      currentData = currentData.answers[values[i]];
    }
    var output = $('output');
    while(output.firstChild){
      output.removeChild(output.firstChild)
    }
    output.appendChild(printTable);
  }

  createRow = function(data){
    var row = _('tr');
    for(var i = 0, l = data.length; i < l; i++){
      var cell = _('td');
      cell.appendChild(__(data[i]));
      row.appendChild(cell);
    }
    return row;
  }

  getSelectedValues = function(){
    var selected, toReturn = [];
    selected  = form.getElementsByTagName("select");
    for(var i = 0, l = selected.length; i < l; i++){
      var val =selected[i].options[selected[i].selectedIndex].value;
      if(val){
        toReturn.push(val);
      }
    }
    return toReturn;
  }
  getSelectedText = function(){
    var selected, toReturn = [];
    selected  = form.getElementsByTagName("select");
    for(var i = 0, l = selected.length; i < l; i++){
      var val =selected[i].options[selected[i].selectedIndex].value;
      var text = selected[i].options[selected[i].selectedIndex].textContent;
      if(val){
        toReturn.push(text);
      }
    }
    return toReturn;
  }
  reset = function(){
    while(output.firstChild){
      output.removeChild(output.firstChild);
    }
    setUp();
  }

  getData();
  </script>
</head>
<body>
  <header>
    <nav id='nav'>
      <span>Data Sets</span>
    </nav>
  </header>
  <main>
    <h1 id='category'></h1>
    <form>
    </form>
    <button onclick="setUp()">Reset</button>
    <button onclick='print()'>Print</button>
    <button>Save</button>
    <span id="output"></span>
  </main>
</body>
</html>
