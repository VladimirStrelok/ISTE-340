<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Project 1</title>
  <link rel="stylesheet" href="css/styles.css">
  <!--[if lt IE 9]>
    <script>
      document.createElement('nav');
      document.createElement('header');
      document.createElement('main');
    </script>
  <![endif]-->
  <!--[if lt IE 8]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/json3/3.3.2/json3.min.js"></script>
  <![endif]-->
  <!--[if lt IE 7]>
    <script>
      window.location = 'http://whatbrowser.org/';
    </script>
  <![endif]-->

  <script>

    //fixing IE8 isue with Object.keys
    if (!Object.keys) {
      Object.keys = function(obj) {
        var keys = [];
        for (var i in obj) {
          if (obj.hasOwnProperty(i)) {
            keys.push(i);
          }
        }
        return keys;
      };
    }
  // Shortcuts
  var $, __, _, __;

  // getElementById shortcut
  $ = function (id){
    return document.getElementById(id);
  }

  // getElementsTagName shortcut
  $$ = function (tag,which){
    if(which){
      return document.getElementsByTagName(tag)[which];
    }
    else{
      return document.getElementsByTagName(tag);
    }
  }

  //createElement shortcut
  _ = function (tag, attributes){
    var ele = document.createElement(tag);
    for(var i = 0, l = attributes.length; i < l; i ++){
      ele.setAttribute(attributes[i][0],attributes[i][1]);
    }
    return ele;
  }

 __ = function(text){
   return document.createTextNode(text);
 }

  // variables
  var jsonData, activeDatasetName, activeDataset, form;

  // functions
  var getData, startUp, setUp, createSection, createSelect, selectChange, generateNav, anchorClick, print, getSelected;

  getData = function(){
    var request, response;
    request = new XMLHttpRequest();
    request.open( "GET", "./data.json", true );
    request.setRequestHeader("Content-type", "application/json");

    request.onreadystatechange = function(){
      if( request.readyState == 4 && request.status == 200 ){
        jsonData = JSON.parse( request.responseText );
        startUp();
      }
    }
    request.send();
  }

  startUp = function(){
    activeDatasetName = Object.keys(jsonData)[0];
    form = document.forms[0];
    generateNav();
    setUp();
  }

  setUp = function(){
    var initial, category;

    while(form.firstChild){
      form.removeChild(form.firstChild);
    }

    activeDataset = jsonData[activeDatasetName];
    $(activeDatasetName).setAttribute('class','active')

    initial = createSelect(activeDataset)
    form.appendChild(initial);

    category = $('category');
    category.addChild = activeDataset.value;
  }
  createSelect = function(data){
    if(data.children){
      var element = _('select',[['onchange','selectChange(this)']]);
      var firstChild =  _("option",[["value",""],["disabled", true],["selected", true],["hidden", true]]);
      firstChild.appendChild(__("Choose an Option"));
      element.appendChild(firstChild);
      var keys = Object.keys(data.children);
      for(var i=0, l=keys.length; i < l; i++){
        var key = keys[i];
        var child = _('option',[['value',key]]);
        child.appendChild(__(data.children[key].value));
        element.appendChild(child);
      }
      return element;
    }

  }
  selectChange = function(cur){;
    while(cur.nextSibling){
      cur.parentNode.removeChild(cur.nextSibling)
    }
    var currentNode = cur.parentNode.firstChild;
    var currentData = activeDataset;
    do{
      currentData = currentData.children[currentNode.value];
    } while(currentNode = currentNode.nextSibling);
    var nextChild = createSelect(currentData);
    if(nextChild){
      form.appendChild(nextChild);
    }
  }
  generateNav = function(){
    var keys = Object.keys(jsonData);
    var nav = $("nav");
    for(var i=0, l=keys.length; i < l; i++){
      var key = keys[i];
      var anchor = _('a',[["id",key],["onclick","anchorClick(this)"]]);
      anchor.appendChild(__(jsonData[key].value));
      nav.appendChild(anchor);
    }
  }
  anchorClick = function(anchor){
    if(anchor.id != activeDatasetName){
      var nav = $("nav");
      var anchors = nav.getElementsByTagName('a');
      for(var i = 0, l=anchors.length; i < l; i++){
        anchors[i].setAttribute('class','');
      }
      activeDatasetName = anchor.id;
      setUp();
    }
  }
  getSelectedValues = function(){
    var selected, toReturn = [];
    selected  = form.getElementsByTagName("select");
    for(var i = 0, l = selected.length; i < l; i++){
      var val =selected[i].options[selected[i].selectedIndex].value;
      if(val){
        toReturn.push(val);
      }
    }
    return toReturn;
  }
  getSelectedText = function(){
    var selected, toReturn = [];
    selected  = form.getElementsByTagName("select");
    for(var i = 0, l = selected.length; i < l; i++){
      var val =selected[i].options[selected[i].selectedIndex].value;
      var text = selected[i].options[selected[i].selectedIndex].textContent;
      if(val){
        toReturn.push(text);
      }
    }
    return toReturn;
  }
  print = function(){
    var values = getSelectedText();
    var toPrint = "";
    for(var i = 0, l = values.length; i<l; i++){
      toPrint = toPrint + values[i]
      if(i != l-1){
        toPrint = toPrint + " => ";
      }
    }
    var output = $('output');
    while(output.firstChild){
     output.removeChild(output.firstChild)
    }
    output.appendChild(__(toPrint));
  }
  getData();
  </script>
</head>
<body>
  <header>
    <nav id='nav'>
      <span>Data Sets</span>
    </nav>
  </header>
  <main>
    <h1 id='category'></h1>
    <form>
    </form>
    <button onclick="setUp(activeDatasetName)">Reset</button>
    <button onclick='print()'>Print</button>
    <button>Save</button>
    <span id="output"></span>
  </main>
</body>
</html>
